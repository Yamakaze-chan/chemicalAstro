---
import { onMount } from "astro/client";
---

<section class="min-h-screen bg-gray-50 py-16 px-6 pt-24">
  <div id="editnew" class="max-w-7xl mx-auto px-4 flex flex-col lg:flex-row gap-12 mt-[5%]"></div>
</section>

<style>
  .btn {
    background-color: #e5e7eb;
    padding: 6px 10px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn:hover {
    background-color: #d1d5db;
  }

  #editor img {
    display: block;
    width: 120%;
    height: auto;
    margin: 1rem auto;
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
</style>
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<script type="module">
const newEdit = document.getElementById('editnew');
const urlParams = new URLSearchParams(window.location.search);
const id = parseInt(urlParams.get("id"));

const response = await fetch(`/api/news?id=${id}`);
if (!response.ok) {
  newEdit.innerHTML = `<p class="text-red-500 text-center text-lg">❌ Không tìm thấy tin tức.</p>`;
  throw new Error("Không tìm thấy tin tức");
}
const item = await response.json();

if (!item) {
  newEdit.innerHTML = `<p class="text-red-500 text-center text-lg">❌ Không tìm thấy tin tức.</p>`;
} else {
  newEdit.innerHTML = `
  <div class="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-xl w-full">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">✏️ Sửa Tin Tức</h1>

    <form id="edit-form" class="space-y-6">
      <input type="hidden" name="id" value="${item.id}" />

      <div>
        <label class="block font-semibold text-gray-700 mb-1">📝 Tiêu đề</label>
        <input type="text" name="title" value="${item.title}" required
          class="w-full border border-gray-300 rounded px-4 py-2" />
      </div>

      <div>
        <label class="block font-semibold text-gray-700 mb-1">👤 Tác giả</label>
        <input type="text" name="author" value="${item.author}" required
          class="w-full border border-gray-300 rounded px-4 py-2" />
      </div>

     <div id="toolbar" class="flex flex-wrap gap-2 mb-2">
      <button type="button" onclick="execCmd('bold')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-bold shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">B</button>
      <button type="button" onclick="execCmd('italic')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 italic font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">I</button>
      <button type="button" onclick="execCmd('underline')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 underline font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">U</button>
     
      <select onchange="applyCustomFontSize(this.value)"
        class="px-2 py-2 border border-gray-300 rounded-md text-sm bg-white shadow-sm hover:bg-gray-100 transition duration-150">
        <option value="">Cỡ chữ</option>
        <option value="12">12px</option>
        <option value="14">14px</option>
        <option value="16">16px</option>
        <option value="18">18px</option>
        <option value="24">24px</option>
        <option value="32">32px</option>
        <option value="40">40px</option>
        <option value="50">50px</option>
      </select>

      <button type="button" onclick="execCmd('justifyLeft')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">⬅️ Trái</button>
      <button type="button" onclick="execCmd('justifyCenter')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">↔️ Giữa</button>
      <button type="button" onclick="execCmd('justifyRight')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">➡️ Phải</button>
      <button type="button" onclick="execCmd('justifyFull')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">📝 Đều</button>

      <button type="button" onclick="execCmd('insertImage')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">🖼</button>
      <button type="button" onclick="uploadImageToEditor()" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">☁️ Upload ảnh</button>
      <button type="button" onclick="insertTable()" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">📋 Table</button>
      <button type="button" onclick="execCmd('createLink')" class="px-4 py-2 rounded-md bg-gray-100 text-gray-800 font-medium shadow-sm hover:bg-[var(--color-3)] hover:text-white transition duration-150">🔗 Link</button>

      <button type="button" onclick="execCmd('removeFormat')" class="px-4 py-2 rounded-md bg-red-100 text-red-700 font-medium shadow-sm hover:bg-red-600 hover:text-white transition duration-150">❌ Clear</button>
    </div>


      <div>
        <label class="block font-semibold text-gray-700 mb-1">📜 Nội dung</label>
        <div id="editor" contenteditable="true" class="bg-white border border-gray-300 rounded px-4 py-2 h-96 overflow-y-auto"></div>
        <input type="hidden" name="content" id="content" />
      </div>

      <div class="flex justify-end">
        <button type="submit"
          class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold shadow">
          ✅ Lưu thay đổi
        </button>
      </div>

      <p id="status" class="mt-4 text-sm text-green-600 font-semibold"></p>
    </form>
  </div>
  `;

  const editor = document.getElementById("editor");
  editor.innerHTML = item.content || "";

  // Áp dụng lại style cho ảnh đã tồn tại trong nội dung
  editor.querySelectorAll("img").forEach(img => {
    img.style.display = "block";
    img.style.maxWidth = "100%";
    img.style.height = "auto";
    img.style.margin = "1rem auto";
    img.style.borderRadius = "0.5rem";
    img.style.boxShadow = "0 4px 12px rgba(0,0,0,0.1)";
  });

  const form = document.getElementById("edit-form");
  const statusEl = document.getElementById("status");
  const contentInput = document.getElementById("content");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = form.querySelector("input[name='id']").value;
    const title = form.querySelector("input[name='title']").value;
    const author = form.querySelector("input[name='author']").value;
    const content = editor.innerHTML;
    contentInput.value = editor.innerHTML;

    const res = await fetch("/api/update-news", {
      method: "POST",
      headers: { "Content-type": "application/json" },
      body: JSON.stringify({ id, title, author, content }),
    });

    const data = await res.json();
    if (data.success) {
      statusEl.textContent = "✅ Cập nhật thành công!";
    } else {
      statusEl.textContent = "❌ Lỗi cập nhật: " + (data.message || "Không xác định");
    }
  });
}

window.execCmd = function (command) {
  if (command === 'insertImage') {
    const url = prompt("Nhập URL hình ảnh:");
    if (url) {
      const imgTag = `<img src="${url}" style="display:block;max-width:100%;margin:1rem auto;border-radius:0.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.1);" />`;
      document.execCommand('insertHTML', false, imgTag);
    }
  } else if (command === 'createLink') {
    const url = prompt("Nhập URL liên kết:");
    if (url) document.execCommand('createLink', false, url);
  } else {
    document.execCommand(command, false, null);
  }
};

window.applyCustomFontSize = function (px) {
  if (!px) return;

  document.execCommand("fontSize", false, "7");

  const editor = document.getElementById("editor");
  const fonts = editor.querySelectorAll("font[size='7']");
  fonts.forEach(font => {
    font.removeAttribute("size");
    font.style.fontSize = px + "px";
  });
};



window.insertTable = function () {
  const rows = prompt("Số hàng:", 2);
  const cols = prompt("Số cột:", 2);
  if (!rows || !cols) return;

  let table = "<table border='1' style='border-collapse:collapse;width:100%;'>";
  for (let i = 0; i < rows; i++) {
    table += "<tr>";
    for (let j = 0; j < cols; j++) {
      table += "<td>&nbsp;</td>";
    }
    table += "</tr>";
  }
  table += "</table><br/>";
  document.execCommand('insertHTML', false, table);
};
const cloudName = "dlwv8fyyj"; // Thay bằng cloudName của bạn nếu khác
const uploadPreset = "chemical_img"; // Thay bằng uploadPreset bạn đang dùng

function uploadImageToEditor() {
  const widget = cloudinary.createUploadWidget(
    {
      cloudName,
      uploadPreset,
      multiple: false,
      sources: ['local'],
      defaultSource: 'local',
    },
    (error, result) => {
      if (!error && result && result.event === "success") {
        const url = result.info.secure_url;
        const imgTag = `<img src="${url}" style="display:block;max-width:100%;margin:1rem auto;border-radius:0.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.1);" />`;
        document.execCommand('insertHTML', false, imgTag);
      }
    }
  );

  widget.open();
}

window.uploadImageToEditor = uploadImageToEditor;

</script>
