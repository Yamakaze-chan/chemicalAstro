---
import '../../styles/global.css';
---
<section class="bg-white py-12 text-[var(--color-3)]">
  <div class="max-w-7xl mx-auto px-4">
    <h1 class="text-[var(--color-3)] text-4xl md:text-5xl xl:text-6xl font-semibold max-w-3xl mx-auto mb-16 leading-snug text-center">
      Tin Tá»©c
    </h1>

    <!-- VÃ¹ng sáº½ render báº±ng JS -->
    <div id="news-section" class="flex flex-col gap-10"></div>

    <div class="text-center mt-6">
      <a 
        href="../news" 
        class="inline-block text-[var(--color-4)] font-semibold border border-[var(--color-4)] px-4 py-2 rounded hover:bg-[var(--color-4)] hover:text-white transition duration-300"
      >
        Xem thÃªm tin tá»©c
      </a>
    </div>
  </div>
</section>

<script type="module">
  const container = document.getElementById("news-section");

  function getFirstImage(content) {
    const match = content.match(/<img[^>]*src=["']([^"']+)["']/i);
    return match ? match[1] : "/images/placeholder.jpg";
  }

  function getFirstText(content) {
    const match = content.match(/<(h2|p)[^>]*>(.*?)<\/\1>/i);
    if (!match) return "";
    const rawText = match[2];
    return rawText.replace(/<[^>]+>/g, "").trim();
  }

  function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString("vi-VN", {
      day: "2-digit", month: "2-digit", year: "numeric",
      hour: "2-digit", minute: "2-digit"
    });
  }

  async function loadNews() {
    try {
      const res = await fetch("/api/news");
      const data = await res.json();

      const news = (Array.isArray(data) ? data : []).sort((a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt)
      ).slice(0, 4).map(item => ({
        ...item,
        imageSrc: item.imageSrc || getFirstImage(item.content),
        imageAlt: item.imageAlt || item.title,
        description: getFirstText(item.content),
        formattedDate: formatDate(item.createdAt),
      }));

      if (news.length === 0) {
        container.innerHTML = "<p class='text-center text-gray-500'>KhÃ´ng cÃ³ tin tá»©c nÃ o.</p>";
        return;
      }

      const [latest, ...others] = news;

      const latestHTML = `
        <a href="/newdetail?id=${latest.id}" class="block group mb-16 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
          <img src="${latest.imageSrc}" alt="${latest.imageAlt}" class="w-full h-80 object-cover rounded-xl shadow group-hover:scale-[1.01] transition-transform duration-200" />
          <div>
            <h2 class="text-3xl font-bold text-[var(--color-1)] mb-4 group-hover:text-[var(--color-3)] transition">${latest.title}</h2>
            <p class="text-gray-600 text-sm mb-1">ğŸ•’ ${latest.formattedDate}</p>
            <p class="text-gray-700">${latest.description}</p>
            <span class="inline-block mt-4 text-[var(--color-3)] font-semibold group-hover:underline">Äá»c thÃªm â†’</span>
          </div>
        </a>
      `;

      const othersHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
          ${others.map(item => `
            <a href="/newdetail?id=${item.id}" class="block group">
              <article class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition flex flex-col h-full">
                <img src="${item.imageSrc}" alt="${item.imageAlt}" class="h-48 w-full object-cover group-hover:scale-[1.01] transition-transform duration-200" />
                <div class="p-5 flex flex-col flex-grow">
                  <h4 class="text-xl font-semibold mb-2 text-[var(--color-3)] group-hover:text-[var(--color-1)] transition">${item.title}</h4>
                  <p class="text-gray-600 text-sm mb-2">ğŸ•’ ${item.formattedDate}</p>
                  <p class="text-gray-700 mb-4 flex-grow">${item.description.slice(0, 100)}...</p>
                  <span class="text-[var(--color-3)] font-medium group-hover:underline mt-auto">Äá»c thÃªm â†’</span>
                </div>
              </article>
            </a>
          `).join("")}
        </div>
      `;

      container.innerHTML = latestHTML + othersHTML;
    } catch (err) {
      console.error("âŒ Lá»—i khi táº£i tin tá»©c:", err);
      container.innerHTML = "<p class='text-red-500'>KhÃ´ng thá»ƒ táº£i tin tá»©c.</p>";
    }
  }

  loadNews();
</script>
